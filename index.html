<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>絵文字スロットゲーム</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;900&display=swap" rel="stylesheet">
	<style>
		/* 全体のスタイル */
		body {
			font-family: 'M PLUS Rounded 1c', sans-serif;
			background-color: #1a2a3a;
			color: #ffffff;
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			margin: 0;
			user-select: none;
		}

		/* ゲーム全体のコンテナ */
		#game-container {
			background: linear-gradient(45deg, #3a4a5a, #2a3a4a);
			border-radius: 20px;
			padding: 20px 30px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.1);
			border: 2px solid #5a6a7a;
			text-align: center;
			width: 90%;
			max-width: 400px;
		}

		/* ヘッダー部分 */
		header h1 {
			font-size: 2.5rem;
			font-weight: 900;
			color: #ffc107;
			text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
			margin: 0 0 10px 0;
		}

		/* コイン表示 */
		#credits-display {
			background-color: #111;
			color: #00ff00;
			font-size: 1.5rem;
			padding: 10px;
			border-radius: 10px;
			margin-bottom: 20px;
			border: 2px solid #444;
			box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
		}

		/* スロットマシン本体 */
		#slot-machine {
			display: flex;
			justify-content: center;
			gap: 10px;
			background-color: #000;
			padding: 15px;
			border-radius: 15px;
			border: 5px solid #888;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
			margin-bottom: 20px;
		}

		/* 各リール */
		.reel {
			background-color: #fff;
			border: 2px solid #333;
			border-radius: 10px;
			overflow: hidden;
			width: 80px;
			height: 240px;
			/* 80px * 3セル分 */
			position: relative;
		}

		.reel-inner {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
		}

		/* 各マス */
		.cell {
			width: 80px;
			height: 80px;
			font-size: 50px;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: #fff;
			color: #333;
			border-bottom: 1px solid #ccc;
		}

		.cell:last-child {
			border-bottom: none;
		}

		/* 結果表示エリア */
		#result-display {
			height: 50px;
			font-size: 1.2rem;
			font-weight: bold;
			color: #ffeb3b;
			display: flex;
			justify-content: center;
			align-items: center;
			transition: all 0.3s ease;
		}

		/* スピンボタン */
		#spin-button {
			background: linear-gradient(180deg, #f44336, #d32f2f);
			color: white;
			font-size: 1.8rem;
			font-weight: 700;
			padding: 15px 40px;
			border: none;
			border-radius: 50px;
			cursor: pointer;
			box-shadow: 0 5px 0 #9a0007, 0 8px 15px rgba(0, 0, 0, 0.4);
			transition: all 0.1s ease-in-out;
		}

		#spin-button:disabled {
			background: #777;
			box-shadow: 0 5px 0 #444;
			cursor: not-allowed;
		}

		#spin-button:not(:disabled):active {
			transform: translateY(5px);
			box-shadow: 0 0px 0 #9a0007;
		}

		/* スピン中のアニメーション */
		.spinning .reel-inner {
			animation: scroll-reel 0.2s linear infinite;
		}

		@keyframes scroll-reel {
			from {
				transform: translateY(-50%);
			}

			to {
				transform: translateY(0);
			}
		}

		/* 当たったラインのハイライト */
		.winning-cell {
			animation: win-pulse 0.8s infinite;
		}

		@keyframes win-pulse {
			0% {
				transform: scale(1);
				background-color: #fff2ab;
			}

			50% {
				transform: scale(1.1);
				background-color: #ffc107;
			}

			100% {
				transform: scale(1);
				background-color: #fff2ab;
			}
		}
	</style>
</head>

<body>

	<div id="game-container">
		<header>
			<h1>絵文字スロット</h1>
			<div id="credits-display">コイン: 1000</div>
		</header>

		<main>
			<div id="slot-machine">
				<div class="reel" id="reel1"></div>
				<div class="reel" id="reel2"></div>
				<div class="reel" id="reel3"></div>
			</div>

			<div id="result-display">ボタンを押してスタート！</div>
			<button id="spin-button">スピン！</button>
		</main>
	</div>

	<script>
		// --- DOM要素の取得 ---
		// HTMLから操作したい要素を取得し、定数に格納しておく
		const reelElements = [
			document.getElementById('reel1'),
			document.getElementById('reel2'),
			document.getElementById('reel3')
		];
		const spinButton = document.getElementById('spin-button');
		const creditsDisplay = document.getElementById('credits-display');
		const resultDisplay = document.getElementById('result-display');

		// --- ゲームの基本設定 ---

		// 各リールの絵柄の並び順（リールストリップ）
		// ブランク絵柄をなくし、当たりが出やすいように調整。
		// また、リールの並びはシャッフルせず、当たりが出やすいようにしつつも、
		// 高配当の絵柄が連続しないように手動で最適な並び順に調整している。
		const reel1 = [
			'🍒', '🍉', '🔔', 'BAR', '👑', '🍒', '🍉', '🔔', '🍒', 'BAR', '🍉', '🍒', '７', '🔔', '🍒', '🍉', 'BAR', '👑', '🔔', '🍒', '🍉'
		]; // 合計21マス
		const reel2 = [
			'BAR', '🍒', '🍉', '🔔', '👑', '🍒', '🍉', 'BAR', '🔔', '🍒', '７', '🍉', '🍒', '🔔', 'BAR', '👑', '🍒', '🍉', '🔔', '🍒', '🍉'
		]; // 合計21マス
		const reel3 = [
			'👑', 'BAR', '🍒', '🍉', '🔔', '🍒', '７', '🍉', 'BAR', '🔔', '🍒', '🍉', '👑', '🔔', '🍒', 'BAR', '🍉', '🔔', '🍒', '🍉', '🍒'
		]; // 合計21マス
		const reels = [reel1, reel2, reel3]; // 3本のリールを配列にまとめる

		// 配当表 (キーは揃った絵柄を連結した文字列)
		// どの絵柄が3つ揃うと、何コインの配当があるかを定義する
		const payoutTable = {
			'７７７': 300,
			'👑👑👑': 100,
			'BARBARBAR': 80,
			'🔔🔔🔔': 50,
			'🍉🍉🍉': 20,
			'🍒🍒🍒': 10,
		};
		

		// --- ゲームの状態管理 ---
		// ゲームの進行状況を保存するための変数
		let credits = 1000; // 所持コイン
		const spinCost = 10; // 1スピンあたりの消費コイン
		let isSpinning = false; // 現在スピン中かどうかを示すフラグ

		// --- ゲームロジック ---

		/**
		 * ゲームの初期化処理
		 * ページが読み込まれたときに最初に実行される
		 */
		function init() {
			updateCreditsDisplay(); // コイン表示を更新
			// 3本のリールの初期表示をランダムに設定
			reels.forEach((reel, i) => {
				const stopIndex = Math.floor(Math.random() * reel.length);
				updateReelDisplay(i, stopIndex);
			});
		}

		/**
		 * スピンボタンが押されたときのメイン処理
		 */
		async function handleSpin() {
			// スピン中、またはコインが足りない場合は処理を中断
			if (isSpinning || credits < spinCost) return;

			// スピン開始の準備
			isSpinning = true; // スピン中の状態にする
			spinButton.disabled = true; // ボタンを一時的に無効化
			resultDisplay.textContent = 'スピン中...'; // メッセージを更新
			clearWinHighlights(); // 前回の当たりハイライトを消す

			// スピンのコストを支払う
			credits -= spinCost;
			updateCreditsDisplay(); // コイン表示を更新

			// 3本すべてのリールのアニメーションを開始
			reelElements.forEach((reelEl, i) => {
				setupSpinningReel(i); // アニメーション用のリールを準備
				reelEl.classList.add('spinning'); // CSSでアニメーションを適用
			});


			// 各リールを少しずつタイミングをずらして停止させる
			const stopIndexes = []; // 各リールの停止位置を保存する配列
			for (let i = 0; i < reels.length; i++) {
				// 0.2秒待ってから次のリールを停止する
				await new Promise(resolve => setTimeout(resolve, 200));
				// ランダムな位置でリールを停止
				const stopIndex = Math.floor(Math.random() * reels[i].length);
				stopIndexes.push(stopIndex);
				// アニメーションを停止し、最終的な結果を表示
				reelElements[i].classList.remove('spinning');
				updateReelDisplay(i, stopIndex);
			}

			// 当たり判定を実行
			checkWin(stopIndexes);

			// スピン終了後の処理
			isSpinning = false; // スピン中の状態を解除
			if (credits >= spinCost) {
				spinButton.disabled = false; // コインがあればボタンを再度有効化
			} else {
				resultDisplay.textContent = 'コインが足りません！';
			}
		}

		/**
		 * スピン中のアニメーション用にリールの表示を準備する
		 * @param {number} reelIndex - 準備するリールの番号 (0-2)
		 */
		function setupSpinningReel(reelIndex) {
			const reel = reels[reelIndex];
			const reelEl = reelElements[reelIndex];
			reelEl.innerHTML = ''; // 現在の表示を一旦クリア

			const reelInner = document.createElement('div');
			reelInner.classList.add('reel-inner');

			// アニメーションが途切れないように、絵柄を2周分つなげて配置する
			const extendedSymbols = [...reel, ...reel];

			// 各絵柄をセルとしてHTMLに追加
			for (const symbol of extendedSymbols) {
				const cell = document.createElement('div');
				cell.classList.add('cell');
				cell.textContent = symbol;
				reelInner.appendChild(cell);
			}
			reelEl.appendChild(reelInner);
		}


		/**
		 * 当たり判定処理
		 * @param {number[]} stopIndexes - 3つのリールの停止位置の配列
		 */
		function checkWin(stopIndexes) {
			const board = getBoard(stopIndexes); // 現在の表示盤面を取得
			let totalWin = 0; // 合計獲得コイン

			// 当たりラインの定義（上段、中段、下段、右下がり、右上がり）
			const paylines = [
				[0, 0, 0], // 上段
				[1, 1, 1], // 中段
				[2, 2, 2], // 下段
				[0, 1, 2], // 右下がり斜め
				[2, 1, 0] // 右上がり斜め
			];

			const winningLines = []; // 当たったラインの情報を保存
			let hasThreeOfAKind = false; // チェリー以外の3つ揃いがあったか

			// 5つの当たりラインを順番にチェック
			paylines.forEach((line, lineIndex) => {
				const symbol1 = board[0][line[0]];
				const symbol2 = board[1][line[1]];
				const symbol3 = board[2][line[2]];

				// 3つの絵柄がすべて同じ場合
				if (symbol1 === symbol2 && symbol2 === symbol3) {
					const winKey = `${symbol1}${symbol2}${symbol3}`;
					// 配当表にその絵柄の組み合わせがあれば、当たりとする
					if (payoutTable[winKey]) {
						totalWin += payoutTable[winKey];
						winningLines.push(lineIndex);
						// チェリー以外の3つ揃いがあったことを記録
						if (symbol1 !== '🍒') {
							hasThreeOfAKind = true;
						}
					}
				}
			});

			// チェリーの特別ルール判定（チェリー以外の3つ揃いがなかった場合のみ）
			if (!hasThreeOfAKind) {
				const cherryLine = [board[0][1], board[1][1], board[2][1]]; // 中段ラインのみで判定
				const cherryCount = cherryLine.filter(s => s === '🍒').length;

				// 他に当たりがなく、チェリーが2つ揃った場合
				if (totalWin === 0) {
					if (cherryCount === 2) {
						totalWin += cherryPayout.count2;
						if (!winningLines.includes(1)) winningLines.push(1);
					} else if (cherryLine[0] === '🍒' && cherryLine[1] !== '🍒' && cherryLine[2] !== '🍒') { // 左端にチェリーが1つだけの場合
						totalWin += cherryPayout.count1;
						if (!winningLines.includes(1)) winningLines.push(1);
					}
				}
			}


			// 最終的な結果の表示とコインの更新
			if (totalWin > 0) {
				credits += totalWin;
				resultDisplay.textContent = `${totalWin}コイン GET!`;
				highlightWinningLines(winningLines); // 当たりラインをハイライト
			} else {
				resultDisplay.textContent = '残念！';
			}
			updateCreditsDisplay(); // コイン表示を更新
		}

		/**
		 * 現在の表示盤面を3x3の2次元配列で取得する
		 * @param {number[]} stopIndexes - 3つのリールの停止位置の配列
		 * @returns {string[][]} 3x3の盤面データ (例: [['🍒','🔔','🍉'], ['🍒','🔔','🍉'], ['🍒','🔔','🍉']])
		 */
		function getBoard(stopIndexes) {
			return stopIndexes.map((stopIndex, reelIndex) => {
				const reel = reels[reelIndex];
				const reelLength = reel.length;
				// 停止位置の前後の絵柄を取得して、[上段, 中段, 下段] の配列を作成
				const top = reel[(stopIndex - 1 + reelLength) % reelLength];
				const middle = reel[stopIndex];
				const bottom = reel[(stopIndex + 1) % reelLength];
				return [top, middle, bottom];
			});
		}

		/**
		 * リールの表示を更新する（スピン停止時に使用）
		 * @param {number} reelIndex - 更新するリールの番号 (0-2)
		 * @param {number} stopIndex - 停止する絵柄のインデックス
		 */
		function updateReelDisplay(reelIndex, stopIndex) {
			const reel = reels[reelIndex];
			const reelLength = reel.length;
			const reelEl = reelElements[reelIndex];

			reelEl.innerHTML = ''; // 現在の表示をクリア

			const reelInner = document.createElement('div');
			reelInner.classList.add('reel-inner');

			// 停止位置とその前後の絵柄のみを表示する
			const symbolsToShow = [
				reel[(stopIndex - 1 + reelLength) % reelLength],
				reel[stopIndex],
				reel[(stopIndex + 1) % reelLength],
			];

			for (const symbol of symbolsToShow) {
				const cell = document.createElement('div');
				cell.classList.add('cell');
				cell.textContent = symbol;
				reelInner.appendChild(cell);
			}
			reelEl.appendChild(reelInner);
		}

		/**
		 * 所持コインの表示を更新する
		 */
		function updateCreditsDisplay() {
			creditsDisplay.textContent = `コイン: ${credits}`;
		}

		/**
		 * 当たったラインをハイライトする
		 * @param {number[]} lineIndexes - 当たったペイラインのインデックスの配列
		 */
		function highlightWinningLines(lineIndexes) {
			const paylines = [
				[0, 0, 0], // 上段
				[1, 1, 1], // 中段
				[2, 2, 2], // 下段
				[0, 1, 2], // 右下がり斜め
				[2, 1, 0]  // 右上がり斜め
			];

			// 当たったラインに含まれるすべてのセルにハイライト用のCSSクラスを付与
			lineIndexes.forEach(lineIndex => {
				const line = paylines[lineIndex];
				line.forEach((cellRowIndex, reelIndex) => {
					const reelEl = reelElements[reelIndex];
					const cell = reelEl.querySelector(`.reel-inner .cell:nth-child(${cellRowIndex + 1})`);
					if (cell) {
						cell.classList.add('winning-cell');
					}
				});
			});
		}


		/**
		 * 全ての当たりハイライトを消す
		 */
		function clearWinHighlights() {
			document.querySelectorAll('.winning-cell').forEach(el => {
				el.classList.remove('winning-cell');
			});
		}


		// --- イベントリスナー ---
		// スピンボタンがクリックされたら、handleSpin関数を実行する
		spinButton.addEventListener('click', handleSpin);

		// --- ゲーム開始 ---
		// ページの読み込みが完了したら、ゲームを初期化する
		init();
	</script>
</body>

</html>